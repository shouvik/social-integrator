# Normalized Schema

## Table of Contents

- [Overview](#overview)
- [Schema Definition](#schema-definition)
- [Field Glossary](#field-glossary)
- [Provider Mappings](#provider-mappings)
- [JSON Schema](#json-schema)
- [Examples](#examples)

---

## Overview

The OAuth Connector SDK normalizes data from all providers into a single, consistent format: `NormalizedItem`. This allows consumers to work with a unified schema regardless of the data source.

**Design Principles:**

- All fields except core identifiers (`id`, `source`, `externalId`, `userId`) are optional
- Provider-specific data is stored in `metadata` for extensibility
- Timestamps are always ISO 8601 strings
- The schema is validated at runtime using Zod

---

## Schema Definition

```typescript
interface NormalizedItem {
  id: string; // Internal UUID (generated by SDK)
  source: string; // Provider name: 'google' | 'github' | 'reddit' | 'twitter' | 'rss'
  externalId: string; // Provider's unique identifier for this item
  userId: string; // Application user ID
  title?: string; // Item title/subject (optional)
  bodyText?: string; // Main content/description (optional)
  url?: string; // Link to the item (optional)
  author?: string; // Content author/creator (optional)
  publishedAt?: string; // ISO 8601 timestamp (optional)
  metadata?: Record<string, unknown>; // Provider-specific additional data (optional)
}
```

**Validation:**

- `id` must be a valid UUID v4
- `url` must be a valid URL when present
- `publishedAt` must be a valid ISO 8601 datetime string when present
- `metadata` can contain any JSON-serializable data

---

## Field Glossary

### Core Fields (Required)

| Field        | Type            | Description                                 | Example                                                      |
| ------------ | --------------- | ------------------------------------------- | ------------------------------------------------------------ |
| `id`         | `string` (UUID) | Internal unique identifier generated by SDK | `"550e8400-e29b-41d4-a716-446655440000"`                     |
| `source`     | `string`        | Provider name                               | `"github"`, `"google"`, `"reddit"`, `"twitter"`, `"rss"`     |
| `externalId` | `string`        | Provider's original ID for the item         | GitHub repo ID: `"123456789"`, Reddit post ID: `"t3_abc123"` |
| `userId`     | `string`        | Application's user identifier               | `"user-123"`                                                 |

### Content Fields (Optional)

| Field         | Type                | Description                       | Example                                                                     |
| ------------- | ------------------- | --------------------------------- | --------------------------------------------------------------------------- |
| `title`       | `string`            | Title, subject, or name           | `"Example Repository"` (GitHub), `"Meeting Reminder"` (Gmail)               |
| `bodyText`    | `string`            | Main content or description       | Repository description, email snippet, tweet text, RSS content              |
| `url`         | `string` (URL)      | Link to the original item         | `"https://github.com/user/repo"`                                            |
| `author`      | `string`            | Content creator or sender         | `"octocat"` (GitHub), `"user@example.com"` (Gmail), `"@username"` (Twitter) |
| `publishedAt` | `string` (ISO 8601) | Creation or publication timestamp | `"2024-01-15T10:30:00Z"`                                                    |

### Extensibility

| Field      | Type                      | Description                       | Usage                                               |
| ---------- | ------------------------- | --------------------------------- | --------------------------------------------------- |
| `metadata` | `Record<string, unknown>` | Provider-specific additional data | Stars count, labels, subreddit, retweet count, etc. |

**Metadata Examples:**

- GitHub: `{ stars: 42, language: "TypeScript", topics: ["oauth", "sdk"] }`
- Reddit: `{ subreddit: "typescript", score: 156, numComments: 23 }`
- Twitter: `{ retweets: 12, likes: 45, hashtags: ["oauth", "api"] }`

---

## Provider Mappings

### GitHub

**Source Type:** Repository (starred or owned)

| Normalized Field    | GitHub API Field   | Notes                                      |
| ------------------- | ------------------ | ------------------------------------------ |
| `externalId`        | `id`               | Repository ID (number converted to string) |
| `title`             | `name`             | Repository name                            |
| `bodyText`          | `description`      | Repository description                     |
| `url`               | `html_url`         | Link to repository on GitHub               |
| `author`            | `owner.login`      | Repository owner username                  |
| `publishedAt`       | `created_at`       | Repository creation date (ISO 8601)        |
| `metadata.stars`    | `stargazers_count` | Number of stars                            |
| `metadata.language` | `language`         | Primary programming language               |
| `metadata.topics`   | `topics`           | Repository topics/tags                     |

**Example GitHub Raw → Normalized:**

```typescript
// Raw GitHub API response
{
  id: 123456789,
  name: "awesome-project",
  description: "An awesome TypeScript project",
  html_url: "https://github.com/user/awesome-project",
  owner: { login: "user" },
  created_at: "2024-01-15T10:30:00Z",
  stargazers_count: 42,
  language: "TypeScript"
}

// Normalized
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  source: "github",
  externalId: "123456789",
  userId: "user-123",
  title: "awesome-project",
  bodyText: "An awesome TypeScript project",
  url: "https://github.com/user/awesome-project",
  author: "user",
  publishedAt: "2024-01-15T10:30:00Z",
  metadata: { stars: 42, language: "TypeScript" }
}
```

---

### Google (Gmail)

**Source Type:** Email message

| Normalized Field    | Gmail API Field            | Notes                                           |
| ------------------- | -------------------------- | ----------------------------------------------- |
| `externalId`        | `id`                       | Message ID                                      |
| `title`             | `payload.headers[Subject]` | Email subject line                              |
| `bodyText`          | `snippet`                  | First ~200 characters of email body             |
| `url`               | Constructed                | `https://mail.google.com/mail/u/0/#inbox/{id}`  |
| `author`            | `payload.headers[From]`    | Sender email address                            |
| `publishedAt`       | `internalDate`             | Timestamp (milliseconds since epoch → ISO 8601) |
| `metadata.labelIds` | `labelIds`                 | Gmail labels (e.g., `["INBOX", "UNREAD"]`)      |
| `metadata.threadId` | `threadId`                 | Conversation thread ID                          |

**Example Gmail Raw → Normalized:**

```typescript
// Raw Gmail API response
{
  id: "18c1234567890abcd",
  internalDate: "1705316400000",
  snippet: "Meeting reminder: Project sync at 3 PM",
  payload: {
    headers: [
      { name: "Subject", value: "Meeting Reminder" },
      { name: "From", value: "boss@example.com" }
    ]
  },
  labelIds: ["INBOX", "UNREAD", "IMPORTANT"]
}

// Normalized
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  source: "google",
  externalId: "18c1234567890abcd",
  userId: "user-123",
  title: "Meeting Reminder",
  bodyText: "Meeting reminder: Project sync at 3 PM",
  url: "https://mail.google.com/mail/u/0/#inbox/18c1234567890abcd",
  author: "boss@example.com",
  publishedAt: "2024-01-15T10:30:00Z",
  metadata: { labelIds: ["INBOX", "UNREAD", "IMPORTANT"], threadId: "..." }
}
```

---

### Reddit

**Source Type:** Post or comment

| Normalized Field       | Reddit API Field               | Notes                                    |
| ---------------------- | ------------------------------ | ---------------------------------------- |
| `externalId`           | `data.id`                      | Post/comment ID (without prefix)         |
| `title`                | `data.title`                   | Post title (or `undefined` for comments) |
| `bodyText`             | `data.selftext` or `data.body` | Post self-text or comment body           |
| `url`                  | `data.url` or constructed      | Link URL or permalink                    |
| `author`               | `data.author`                  | Reddit username                          |
| `publishedAt`          | `data.created_utc`             | Unix timestamp (seconds → ISO 8601)      |
| `metadata.subreddit`   | `data.subreddit`               | Subreddit name                           |
| `metadata.score`       | `data.score`                   | Upvotes - Downvotes                      |
| `metadata.numComments` | `data.num_comments`            | Comment count (posts only)               |

**Example Reddit Raw → Normalized:**

```typescript
// Raw Reddit API response
{
  data: {
    id: "abc123",
    title: "How to use OAuth in TypeScript?",
    selftext: "I'm building an app and need help with OAuth...",
    url: "https://www.reddit.com/r/typescript/comments/abc123/...",
    author: "typescript_dev",
    created_utc: 1705316400,
    subreddit: "typescript",
    score: 156,
    num_comments: 23
  }
}

// Normalized
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  source: "reddit",
  externalId: "abc123",
  userId: "user-123",
  title: "How to use OAuth in TypeScript?",
  bodyText: "I'm building an app and need help with OAuth...",
  url: "https://www.reddit.com/r/typescript/comments/abc123/...",
  author: "typescript_dev",
  publishedAt: "2024-01-15T10:30:00Z",
  metadata: { subreddit: "typescript", score: 156, numComments: 23 }
}
```

---

### Twitter (X)

**Source Type:** Tweet

| Normalized Field    | Twitter API Field                 | Notes                                   |
| ------------------- | --------------------------------- | --------------------------------------- |
| `externalId`        | `id` or `id_str`                  | Tweet ID                                |
| `title`             | `undefined`                       | Tweets don't have titles                |
| `bodyText`          | `text` or `full_text`             | Tweet content                           |
| `url`               | Constructed                       | `https://twitter.com/i/web/status/{id}` |
| `author`            | `author_id` or `user.screen_name` | Username or user ID                     |
| `publishedAt`       | `created_at`                      | Timestamp (ISO 8601)                    |
| `metadata.retweets` | `public_metrics.retweet_count`    | Retweet count                           |
| `metadata.likes`    | `public_metrics.like_count`       | Like count                              |
| `metadata.replies`  | `public_metrics.reply_count`      | Reply count                             |
| `metadata.hashtags` | `entities.hashtags`               | Hashtags used in tweet                  |

**Example Twitter Raw → Normalized:**

```typescript
// Raw Twitter API v2 response
{
  id: "1234567890",
  text: "Just shipped OAuth support! #typescript #oauth",
  author_id: "98765",
  created_at: "2024-01-15T10:30:00.000Z",
  public_metrics: {
    retweet_count: 12,
    reply_count: 3,
    like_count: 45,
    quote_count: 2
  },
  entities: {
    hashtags: [{ tag: "typescript" }, { tag: "oauth" }]
  }
}

// Normalized
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  source: "twitter",
  externalId: "1234567890",
  userId: "user-123",
  title: undefined,
  bodyText: "Just shipped OAuth support! #typescript #oauth",
  url: "https://twitter.com/i/web/status/1234567890",
  author: "98765",
  publishedAt: "2024-01-15T10:30:00Z",
  metadata: {
    retweets: 12,
    likes: 45,
    replies: 3,
    quotes: 2,
    hashtags: ["typescript", "oauth"]
  }
}
```

---

### RSS

**Source Type:** Feed item

| Normalized Field      | RSS/Atom Field                | Notes                                  |
| --------------------- | ----------------------------- | -------------------------------------- |
| `externalId`          | `guid` or `link`              | Globally unique ID or fallback to link |
| `title`               | `title`                       | Item title                             |
| `bodyText`            | `contentSnippet` or `content` | Content snippet or full content        |
| `url`                 | `link`                        | Link to the article                    |
| `author`              | `creator` or `author`         | Content creator                        |
| `publishedAt`         | `pubDate`                     | Publication date (ISO 8601)            |
| `metadata.categories` | `categories`                  | Item categories/tags                   |
| `metadata.feedTitle`  | `feedTitle`                   | Source feed title                      |

**Example RSS Raw → Normalized:**

```typescript
// Raw RSS Parser output
{
  guid: "https://example.com/article/123",
  title: "Understanding OAuth 2.0",
  contentSnippet: "A comprehensive guide to OAuth 2.0...",
  link: "https://example.com/article/123",
  author: "Jane Doe",
  pubDate: "Mon, 15 Jan 2024 10:30:00 GMT",
  categories: ["security", "authentication"]
}

// Normalized
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  source: "rss",
  externalId: "https://example.com/article/123",
  userId: "user-123",
  title: "Understanding OAuth 2.0",
  bodyText: "A comprehensive guide to OAuth 2.0...",
  url: "https://example.com/article/123",
  author: "Jane Doe",
  publishedAt: "2024-01-15T10:30:00Z",
  metadata: { categories: ["security", "authentication"] }
}
```

---

## JSON Schema

The SDK automatically generates a JSON Schema from the Zod validation schema. This can be used for:

- Client-side validation in other languages
- OpenAPI/Swagger documentation
- Database schema generation
- Contract testing

**Location:** `src/core/normalizer/schema.json`

**Generate Schema:**

```bash
npm run generate:schema
```

**Use in Your Code:**

```typescript
import schema from 'oauth-connector-sdk/dist/core/normalizer/schema.json';

// Validate against JSON Schema (using ajv, joi, etc.)
const validate = ajv.compile(schema);
const valid = validate(normalizedItem);
```

---

## Examples

See `docs/examples/normalized/` for complete JSON examples from each provider:

- `github.json` - Normalized GitHub repository
- `google.json` - Normalized Gmail message
- `reddit.json` - Normalized Reddit post
- `twitter.json` - Normalized tweet
- `rss.json` - Normalized RSS feed item

---

## Versioning & Evolution

**Schema Version:** `1.0.0`

**Backward Compatibility Promise:**

- No breaking changes to existing fields
- New optional fields may be added
- Metadata structure is provider-specific and may evolve
- Major version bump for any breaking changes

**Deprecation Policy:**

- Deprecated fields remain for 2 major versions
- Deprecation warnings logged when used
- Migration guides provided for breaking changes

---

## See Also

- [Provider Matrix](./provider-matrix.md) - OAuth quirks per provider
- [Configuration Guide](./configuration.md) - SDK setup
- [Troubleshooting](./troubleshooting.md) - Common issues
